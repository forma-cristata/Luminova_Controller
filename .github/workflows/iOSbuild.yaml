name: iOS Build

# Explicit permissions for security
permissions:
  contents: read
  actions: read
  id-token: write

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile to use'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - development
  push:
    branches:
      - production
    paths:
      - 'src/**'
      - 'app.json'
      - 'package.json'
      - 'eas.json'

jobs:
  build:
    name: Build iOS App
    runs-on: ubuntu-latest
    environment: production  # Use GitHub environment for additional security
    outputs:
      build-id: ${{ steps.eas-build.outputs.build-id }}
    steps:
      - name: Validate inputs and secrets
        run: |
          PROFILE="${{ github.event.inputs.build_profile || 'production' }}"
          if [[ ! "$PROFILE" =~ ^(production|preview|development)$ ]]; then
            echo "Invalid build profile: $PROFILE"
            exit 1
          fi
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "EXPO_TOKEN secret required. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi
          echo "Using build profile: $PROFILE"

      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node.js
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: 'lts/*'
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e # v8.2.1
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Validate project configuration
        run: |
          # Check required files exist
          [ -f "app.json" ] || { echo "ERROR: app.json not found"; exit 1; }
          [ -f "eas.json" ] || { echo "ERROR: eas.json not found"; exit 1; }

          # Validate configurations
          PROFILE="${{ github.event.inputs.build_profile || 'production' }}"
          node -e "
            const app = require('./app.json');
            const eas = require('./eas.json');

            if (!app.expo?.ios?.bundleIdentifier) {
              console.error('ERROR: Missing iOS bundleIdentifier in app.json');
              process.exit(1);
            }
            if (!eas.build?.['$PROFILE']) {
              console.error('ERROR: Build profile \"$PROFILE\" not found in eas.json');
              process.exit(1);
            }
            console.log('âœ… Configuration validation passed');
          "

      - name: Build iOS app
        id: eas-build
        run: |
          PROFILE="${{ github.event.inputs.build_profile || 'production' }}"
          echo "Building iOS app with profile: $PROFILE"

          OUTPUT=$(eas build --platform ios --profile $PROFILE --non-interactive 2>&1)
          BUILD_ID=$(echo "$OUTPUT" | grep -oE 'Build ID: [a-f0-9-]+' | head -1 | cut -d' ' -f3)

          if [ -z "$BUILD_ID" ]; then
            echo "Failed to extract build ID"
            echo "$OUTPUT" | tail -10
            exit 1
          fi

          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build started with ID: $BUILD_ID"
