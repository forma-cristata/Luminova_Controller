name: iOS Build

# Explicit permissions for security
permissions:
  contents: read
  actions: read
  id-token: write

on:
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'EAS build profile to use'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - development
  push:
    branches:
      - production
    paths:
      - 'src/**'
      - 'app.json'
      - 'package.json'
      - 'eas.json'

jobs:
  build:
    name: Build iOS App
    runs-on: ubuntu-latest
    environment: production  # Use GitHub environment for additional security
    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
    steps:
      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
          node-version: 'lts/*'
          cache: npm

      - name: Validate configuration
        uses: ./.github/actions/validate-config
        with:
          build-profile: ${{ github.event.inputs.build_profile || 'production' }}

      - name: Build iOS app
        id: build
        uses: ./.github/actions/eas-build
        with:
          platform: ios
          profile: ${{ github.event.inputs.build_profile || 'production' }}
